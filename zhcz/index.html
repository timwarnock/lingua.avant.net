<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My test page</title>
<style>

#flashcard {
  position: relative;
  margin: 100px 0 0 5%;
  border: 1px solid black;
  width: 600px;
  height: 400px;
}
#flashcard-content-wrapper {
  width: 100%;
  height: 100%;
}
#flashcard-front,
#flashcard-back {
  position: relative;
  float: left;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
#flashcard-okay {
  display: block;
  width: 100px;
  height: 40px;
  background-color: #666;
  color: white;
  position:absolute;
  bottom: -40px;
  left: 250px;
}
.flashcard-prompt {
  text-align: center;
  font-size: 400%;
}
.flashcard-full-key {
  text-align: center;
  font-size: 400%;
  color: #aaa;
}
.flashcard-full-answer {
  text-align: center;
}
.flashcard-full-alt {
  text-align: center;
}

.hand {
  cursor: pointer;
}

</style>
<script>
/*
*/

//GLOBALS

// worst time (in seconds) for each card
MAX_WAIT = 10;

// this will be set by async json call
var FC_DATA = [
  {"key": "??", "answer": "42", "alt": "43?" },
  {"key": "Pi",   "answer": "3.141592653", "alt": "3" }
];

// audio cache
var FC_AUDIO = [false, false];

// the pointer into FC_DATA and FC_SCORE
var CURR_FC = 0;

// max cards before magic shuffle
var HOW_MANY = 8; 

// the next indeces for CURR_FC
var NEXT_UP = [];

// save state for which side of the card is showing
var FC_STATUS = 'front';

// remember if the user flipped the current card
var FIRST_FLIP = true;


// stopwatch function (use system time)
var START_TS = new Date().getTime();
var startwatch = function() {
  START_TS = new Date().getTime();
};
var stopwatch = function() {
  return (new Date().getTime() - START_TS)/1000;
};



// fetch JSON object from URL
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        var resjson = xhr.response;
        if (typeof resjson == "string") {
          resjson = JSON.parse(xhr.response);
        }
        callback(null, resjson);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.send();
};

// scores will be initialized from localStorage
var FC_SCORE = [0,0];
var FC_NAME;
Storage.prototype.setObj = function(key, obj) {
  return this.setItem(key, JSON.stringify(obj))
}
Storage.prototype.getObj = function(key) {
  return JSON.parse(this.getItem(key))
}
function initScores(fcname) {
  FC_NAME = fcname;
  FC_SCORE = localStorage.getObj(fcname);
  if (!FC_SCORE) {
    clearScores();
  }
}
function clearScores() {
  NEXT_UP = [];
  FC_SCORE = Array.apply(null, Array(FC_DATA.length)).map(Number.prototype.valueOf,MAX_WAIT);
}
function getScore(index) {
  return FC_SCORE[index];
}
function setScore(index,score) {
  FC_SCORE[index] = score;
  localStorage.setObj(FC_NAME,FC_SCORE);
}


// return the current flashcard data
function _currFlashcard() {
  return FC_DATA[CURR_FC];
};

// fetch the next flashcard, and set the internal pointer
function _nextFlashcard() {
  var cand = NEXT_UP.shift();
  if (cand == null) {
    var score_index = reverse_scores_index();
    var how_many = HOW_MANY < score_index.length ? HOW_MANY : score_index.length;
    NEXT_UP = score_index.slice(0,how_many);
    cand = NEXT_UP.shift();
console.log(FC_SCORE);
  }
  //CURR_FC = (CURR_FC + 1) % FC_DATA.length;
  CURR_FC = cand;
  return _currFlashcard();
};

// internal, return reverse-sorted array of indexes (from flashcard scores)
function reverse_scores_index() {
  var toSort = FC_SCORE.slice();
  for (var i = 0; i < toSort.length; i++) {
    toSort[i] = [toSort[i], i];
  }
  toSort.sort(function(left, right) {
    return left[0] > right[0] ? -1 : 1;
  });
  toSort.sortIndices = [];
  for (var j = 0; j < toSort.length; j++) {
    toSort.sortIndices.push(toSort[j][1]);
    toSort[j] = toSort[j][0];
  }
  return toSort.sortIndices;
};

// internal, set the DOM based on the current selected flashcard
function _setFlashcard() {
  var fc = _currFlashcard();
  fcstat( CURR_FC+1 + ' of ' + FC_DATA.length + 'cards');
  var fcf = '<div class="flashcard-prompt">'
  fcf += fc.key + '</div>';
  document.getElementById('flashcard-front').innerHTML = fcf;
  var fcb = '<div class="flashcard-full-answer">' + fc.answer + '</div>';
  fcb += '<div class="flashcard-full-key">' + fc.key + '</div>';
  fcb += '<div class="flashcard-full-alt">' + fc.alt + '</div>';
  document.getElementById('flashcard-back').innerHTML = fcb;
};


// display the front of the flashcard
function showFrontFlashcard() {
  FC_STATUS = 'front';
  document.getElementById('flashcard').classList.remove('back');
  document.getElementById('flashcard').classList.add('front');
  var fcf = document.getElementById('flashcard-front');
  var fcb = document.getElementById('flashcard-back');
  fcf.parentNode.insertBefore(fcf,fcb);
  fcf.style.visibility = "visible";
  fcb.style.visibility = "hidden";
  fcf.style.opacity = "1";
  fcb.style.opacity = "0";
};

// display the back of the flashcard
// start timer if it's the first flip
function showBackFlashcard() {
  FC_STATUS = 'back';
  if (FIRST_FLIP) {
    startwatch();
    FIRST_FLIP = false;
  }
  document.getElementById('flashcard').classList.remove('front');
  document.getElementById('flashcard').classList.add('back');
  var fcf = document.getElementById('flashcard-front');
  var fcb = document.getElementById('flashcard-back');
  fcf.parentNode.insertBefore(fcb,fcf);
  fcf.style.visibility = "hidden";
  fcb.style.visibility = "visible";
  fcf.style.opacity = "0";
  fcb.style.opacity = "1";
  _playAudio();
};

// called when the user advances to the next card
function showNextFlashcard() {
  if (FIRST_FLIP) {
    //user is skipping this card (no score change, for now)
  } else {
    var wait_s = stopwatch();
    wait_s = wait_s < MAX_WAIT ? wait_s : MAX_WAIT;
    var oldscore = getScore(CURR_FC)
    setScore(CURR_FC, (oldscore*4 + wait_s)/5 );
  }
  FIRST_FLIP = true;
  _stopAudio();
  _nextFlashcard();
  _setFlashcard();
  showFrontFlashcard();
};

// flip card from front to back
function toggleFlashcard() {
  if (FC_STATUS === 'front') {
    return showBackFlashcard();
  } else {
    return showFrontFlashcard();
  }
};

// set the status message
function fcstat(msg) {
  document.getElementById('fc-status').innerHTML = msg;
};

// load the flashcard data from JSON
function loadDeck(url) {
  fcstat('loading');
  document.getElementById('flashcard-content-wrapper').style.visibility = "hidden";
  getJSON(url, function(err, data) {
    if (err !== null) {
      console.log('Something went wrong: ' + err);
    } else {
      FC_DATA = data;
      initScores(url);
      FC_AUDIO = preloadAudio(FC_DATA);
      CURR_FC = 0;
      FIRST_FLIP = true;
      NEXT_UP = [];
      _nextFlashcard();
      _setFlashcard();
      showFrontFlashcard();
      document.getElementById('flashcard-content-wrapper').style.visibility = "visible";
    }
  });
};

//preload any audio files
function preloadAudio(data) {
  var audiof = new Array();
  for (var i=0; i<data.length; i++) {
    audiof[i] = false;
    if (data[i].audio) {
      audiof[i] = new Audio();
      audiof[i].addEventListener('canplaythrough', loadedAudio, false); 
      audiof[i].src = 'audio/' + data[i].audio;
    }
  }
  return audiof;
};
function loadedAudio() {
  console.log('audio ready?');
};

// attempt to play the current cards audio
function _playAudio() {
  if (FC_AUDIO[CURR_FC]) {
    var player = document.getElementById('flashcard-audio');
    player.src = FC_AUDIO[CURR_FC].src
    player.play();
  }
};
function _stopAudio() {
  var player = document.getElementById('flashcard-audio');
  player.pause();
};



</script>
</head>
<body>


<div id="fc-status">-</div>

<div class="hand" id="flashcard">
  <div id="flashcard-content-wrapper" onclick="toggleFlashcard()" style="visibility:hidden;">
    <div id="flashcard-front">...</div>
    <div id="flashcard-back" style="visibility:hidden;opacity:0;">#</div>
  </div>
  <div id="flashcard-okay" class="hand" onclick="showNextFlashcard()">okay</div>
  <audio id="flashcard-audio" style="display:none;"></audio>
</div>


<div>
<a href="#" class="hand" onclick="loadDeck('http://www.verbose.net/zhcz/01_hello.json');return false;">Comfort</a>
<br />
<a href="#" class="hand" onclick="loadDeck('http://www.verbose.net/zhcz/02_learning.json');return false;">Learning Zone</a>
<br />
<a href="#" class="hand" onclick="loadDeck('http://www.verbose.net/zhcz/03_danger.json');return false;">Danger Zone</a>
</div>
<a href="#" onclick="clearScores();showNextFlashcard();return false;">start over</a>


</body>
</html>
